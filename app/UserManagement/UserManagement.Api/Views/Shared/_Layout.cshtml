<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>User Management</title>

    <link href="~/Content/bootstrap.min.css" rel="stylesheet">
    <link href="~/Content/sb-admin.css" rel="stylesheet">
    <link href="~/font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href="~/Content/DataTables-1.10.4/css/jquery.dataTables.min.css" rel="stylesheet" />
    <link href="~/Content/chosen.min.css" rel="stylesheet" />
    <link href="~/Content/main.css" rel="stylesheet" />
    <link href="~/Content/site.css" rel="stylesheet" />

    @RenderSection("Header", false)
</head>
<body>
    <div id="wrapper">
        @Html.Partial("Shared/Navigation")
        
        <div id="page-wrapper">
            <div id="container" class="container-fluid">
                @RenderBody()
            </div>
            <!-- /.container-fluid -->
        </div>
        <!-- /#page-wrapper -->
    </div>
    
    <script src="~/Scripts/jquery-2.1.3.min.js"></script>
    <script src="~/Scripts/bootstrap.min.js"></script>
    <script src="~/Scripts/react/react-0.12.2.min.js"></script>
    <script src="~/Scripts/react/JSXTransformer-0.12.2.js"></script>
    <script src="~/Scripts/DataTables-1.10.4/jquery.dataTables.min.js"></script>
    <script src="~/Scripts/chosen.jquery.min.js"></script>
    <script src="~/Scripts/jquery.form.min.js"></script>
    <script src="~/Scripts/jquery.blockUI.js"></script>
    <div id="scripts">@RenderSection("Scripts", false)</div>
    <script>
        $.ajaxSetup({ global: true, cache: false });

        $(".chosen-select").chosen();
        $(function () {
            $(".menu-link").click(function () {
                var $self = $(this);
                var url = $self.attr('href');
                block();
                $.get(url, function (response) {
                    $("#container").html(response);
                }, 'html');
                return false;
            });
        });

        function showRequest(formData, jqForm, options) {
            block();
            var method = jqForm.data('method');
            options.type = method;
            $.ajaxSetup({
                global: false,
                type: method
            });

            return true;
        }
        
        function showResponse(responseText, statusText, xhr, $form) {
            // for normal html responses, the first argument to the success callback 
            // is the XMLHttpRequest object's responseText property 

            // if the ajaxForm method was passed an Options Object with the dataType 
            // property set to 'xml' then the first argument to the success callback 
            // is the XMLHttpRequest object's responseXML property 

            // if the ajaxForm method was passed an Options Object with the dataType 
            // property set to 'json' then the first argument to the success callback 
            // is the json data object returned by the server 

            //alert('status: ' + statusText + '\n\nresponseText: \n' + responseText +
            //    '\n\nThe output div should have already been updated with the responseText.');

            var $div = $("#container");
            $div.html(responseText);
            
            ReinitializeComponents();
        }

        var options = {
            target: '#container',   // target element(s) to be updated with server response 
            beforeSubmit: showRequest,  // pre-submit callback 
            success: showResponse,  // post-submit callback 

            // other available options: 
            //url:       url         // override for form's 'action' attribute 
            //type:      type        // 'get' or 'post', override for form's 'method' attribute 
            dataType:  'html'        // 'xml', 'script', or 'json' (expected server response type) 
            //clearForm: true        // clear all form fields after successful submit 
            //resetForm: true        // reset the form after successful submit 

            // $.ajax options can be used here too, for example: 
            //timeout:   3000 
        };

        function ExecuteScriptsFromAjaxResponse() {
            var $div = $("#container");
            $div.find("script").each(function (i) {
                eval($(this).text());
            });
        }
        
        function ReinitializeComponents() {
            ExecuteScriptsFromAjaxResponse();
            $(".chosen-select").chosen();
            $(".entity-add").on("click", function (e) {
                if (e.handled !== true) // This will prevent event triggering more then once
                {
                    e.handled = true;
                }
                var $self = $(this);
                var url = $self.data('url');
                block();
                $.get(url, function (response) {
                    $("#container").html(response);
                    ReinitializeComponents();
                });
            });
            $('table tbody').on('click', 'button.entity-edit', function (e) {
                if (e.handled !== true) // This will prevent event triggering more then once
                {
                    e.handled = true;
                }
                var $self = $(this);
                var url = $self.data('url');
                var data = table.row($(this).parents('tr')).data();
                block();
                $.get(url + data.id, function (response) {
                    $("#container").html(response);
                    ReinitializeComponents();
                });
            });
            $('form').ajaxForm(options);
        }

        $(document).ajaxComplete(function () {
            ReinitializeComponents();
            $.unblockUI;
        });
        $(document).ajaxStop($.unblockUI);
        
        function block() {
            $.blockUI({ message: '<h1><img src="Content/ajax-loader.gif" /> Loading...</h1>' });
        }
    </script>
</body>
</html>
